name: CD/CD

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed # マージした際のCD実行のため
    branches:
      - develop
      - qa
      - release
      - education
      - main
      - master # テスト用

jobs:
  # ========================================================
  # CI
  # ========================================================
  CI:
    runs-on: ubuntu-latest
    env:
      CI: true
      ALLOW_SUBMIT: ${{ github.base_ref == 'release' || github.base_ref == 'education' || github.base_ref == 'main' }}
    steps:
      - name: 🙌 Checkout
        uses: actions/checkout@v4

      - name: 🥟 Setup Bun
        uses: oven-sh/setup-bun@v2

      # - name: ⬇️ Install Dependencies
      #   run: bun install --no-save

      # - name: 🔎 Lint Check
      #   run: make lint

      # - name: 🔎 Type Check
      #   run: make tsc

      # - name: 🔎 Expo Doctor
      #   run: make expo-doctor

      # - name: 🔎 Test
      #   run: make test

  # ========================================================
  # CD
  #
  # 実行条件
  # 1. CIジョブが成功していること
  # 2. リポジトリのorganizationがnso-rntであること
  # 3. プルリクエストがマージされていること
  # ========================================================
  CD:
    needs: CI
    if: (github.repository_owner == 'NakamuraShun') && (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    env:
      CI: false
      ALLOW_SUBMIT: ${{ github.base_ref == 'release' || github.base_ref == 'education' || github.base_ref == 'main' }}
    steps:
      # - name: 🤖 Check for EXPO_TOKEN
      #   run: |
      #     if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
      #       echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
      #       exit 1
      #     fi

      # - name: ✒️ Define ENVCODE for eas command parameters
      #   run: |
      #     if [ "${{ github.base_ref }}" == "develop" ]; then
      #       echo "ENVCODE=dev" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "qa" ]; then
      #       echo "ENVCODE=qa" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "release" ]; then
      #       echo "ENVCODE=stg" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "education" ]; then
      #       echo "ENVCODE=edu" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "main" ]; then
      #       echo "ENVCODE=prd" >> $GITHUB_ENV
      #     else
      #       echo "Error: ENVCODEを設定できませんでした。"
      #       exit 1
      #     fi

      - name: 🙌 Checkout
        uses: actions/checkout@v4

      - name: 🥟 Setup Bun
        uses: oven-sh/setup-bun@v2

      # - name: 🏗 Setup EAS
      #   uses: expo/expo-github-action@v8
      #   with:
      #     eas-version: latest
      #     token: ${{ secrets.EXPO_TOKEN }}

      # - name: ⬇️ Install Dependencies
      #   run: bun install --no-save

      # - name: 🤖 EAS Build for Taihei app
      #   run: make build PROFILE=$ENVCODE IS_DEVICE_REGISTER=false

      # - name: 🤖 EAS Build for Nishio app
      #   run: make build PROFILE=$ENVCODE-n IS_DEVICE_REGISTER=false

      # - name: 🍎 EAS Submit for Taihei app
      #   if: env.ALLOW_SUBMIT == 'true'
      #   run: make submit SUBMIT_PROFILE=$ENVCODE

      # - name: 🍎 EAS Submit for Nishio app
      #   if: env.ALLOW_SUBMIT == 'true'
      #   run: make submit SUBMIT_PROFILE=$ENVCODE-n
