name: CD/CD

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed # ãƒãƒ¼ã‚¸ã—ãŸéš›ã®CDå®Ÿè¡Œã®ãŸã‚
    branches:
      - develop
      - qa
      - release
      - education
      - main
      - master # ãƒ†ã‚¹ãƒˆç”¨

jobs:
  # ========================================================
  # CI
  # ========================================================
  CI:
    runs-on: ubuntu-latest
    env:
      CI: true
      ALLOW_SUBMIT: ${{ github.base_ref == 'release' || github.base_ref == 'education' || github.base_ref == 'main' }}
    steps:
      - name: ğŸ™Œ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2

      # - name: â¬‡ï¸ Install Dependencies
      #   run: bun install --no-save

      # - name: ğŸ” Lint Check
      #   run: make lint

      # - name: ğŸ” Type Check
      #   run: make tsc

      # - name: ğŸ” Expo Doctor
      #   run: make expo-doctor

      # - name: ğŸ” Test
      #   run: make test

  # ========================================================
  # CD
  #
  # å®Ÿè¡Œæ¡ä»¶
  # 1. CIã‚¸ãƒ§ãƒ–ãŒæˆåŠŸã—ã¦ã„ã‚‹ã“ã¨
  # 2. ãƒªãƒã‚¸ãƒˆãƒªã®organizationãŒnso-rntã§ã‚ã‚‹ã“ã¨
  # 3. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒ¼ã‚¸ã•ã‚Œã¦ã„ã‚‹ã“ã¨
  # ========================================================
  CD:
    needs: CI
    if: (github.repository_owner == 'NakamuraShun') && (github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    env:
      CI: false
      ALLOW_SUBMIT: ${{ github.base_ref == 'release' || github.base_ref == 'education' || github.base_ref == 'main' }}
    steps:
      # - name: ğŸ¤– Check for EXPO_TOKEN
      #   run: |
      #     if [ -z "${{ secrets.EXPO_TOKEN }}" ]; then
      #       echo "You must provide an EXPO_TOKEN secret linked to this project's Expo account in this repo's secrets. Learn more: https://docs.expo.dev/eas-update/github-actions"
      #       exit 1
      #     fi

      # - name: âœ’ï¸ Define ENVCODE for eas command parameters
      #   run: |
      #     if [ "${{ github.base_ref }}" == "develop" ]; then
      #       echo "ENVCODE=dev" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "qa" ]; then
      #       echo "ENVCODE=qa" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "release" ]; then
      #       echo "ENVCODE=stg" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "education" ]; then
      #       echo "ENVCODE=edu" >> $GITHUB_ENV
      #     elif [ "${{ github.base_ref }}" == "main" ]; then
      #       echo "ENVCODE=prd" >> $GITHUB_ENV
      #     else
      #       echo "Error: ENVCODEã‚’è¨­å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
      #       exit 1
      #     fi

      - name: ğŸ™Œ Checkout
        uses: actions/checkout@v4

      - name: ğŸ¥Ÿ Setup Bun
        uses: oven-sh/setup-bun@v2

      # - name: ğŸ— Setup EAS
      #   uses: expo/expo-github-action@v8
      #   with:
      #     eas-version: latest
      #     token: ${{ secrets.EXPO_TOKEN }}

      # - name: â¬‡ï¸ Install Dependencies
      #   run: bun install --no-save

      # - name: ğŸ¤– EAS Build for Taihei app
      #   run: make build PROFILE=$ENVCODE IS_DEVICE_REGISTER=false

      # - name: ğŸ¤– EAS Build for Nishio app
      #   run: make build PROFILE=$ENVCODE-n IS_DEVICE_REGISTER=false

      # - name: ğŸ EAS Submit for Taihei app
      #   if: env.ALLOW_SUBMIT == 'true'
      #   run: make submit SUBMIT_PROFILE=$ENVCODE

      # - name: ğŸ EAS Submit for Nishio app
      #   if: env.ALLOW_SUBMIT == 'true'
      #   run: make submit SUBMIT_PROFILE=$ENVCODE-n
